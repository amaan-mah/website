---
title: "Project"
author: "Mohammed Hussain"
output: 
  html_document:
    self_contained: false
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
      style: "float"
---

<style>
pre.r {
  max-width: 65%;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo       = FALSE,
  include = FALSE,
  message    = FALSE,
  warning    = FALSE,
  out.width  = "65%",
  fig.height = 3,
  fig.width = 2
)
```

```{r libraries}
library(readxl)
library(tidyverse)
library(stringr)
library(factoextra)
library(sf)
library(lwgeom)
library(plotly)
library(leaflet)
```

```{r zip}
zip_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/ZIP_Codes_in_Durham_County/ZIP_Codes_in_Durham_County.shp", quiet = TRUE)
zip_shp <- st_transform(zip_shp, 32119)
```
```{r road, include=FALSE}
road_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/Roads/Roads.shp",quiet = TRUE)
road_shp <- st_transform(road_shp, 32119)
```


![The region of interest mapped in research articles](C:/Users/amaan/Desktop/Project/website/GIS_Data_Code/Region.png){width=150px}

I will map this approximate region using ZIP code region and roads data available on Durham Open Data Portal. The region covers parts of the four ZIP code regions: 27701,27703,27704,27707. The region is bounded by four highways: 15/501,85,885,147.

I ran into a lot of trouble trying to combine roads and cut boundaries with the ZIP code regions. I was trying to make a boundary with the four highways but the individual data points for the roads were numerous to combine into one line string or multi-string. I decided to manually plot four points and connect them as a polygon to mark the region of interest. Then it was easier to intersect the ZIP code regions and roads to focus on the region of interest. I learned that manually plotting points is not uncommon for such a task.

```{r boundaries, echo=TRUE, include=TRUE}
# The boundaries can be manually created using estimated coordinates
cut_poly <- 
  st_polygon(
    list(
      rbind(
        c(-78.90, 36.02),  # NW
        c(-78.86, 36.02),  # NE
        c(-78.86, 35.96),  # SE
        c(-78.90, 35.96),  # SW
        c(-78.90, 36.02)
          )
        )
      )
```


```{r region_map}

# The region of interest extends into three ZIP code regions
zips_sel <- 
  zip_shp |>
  filter(ZIPCODE %in% c("27701","27703","27704","27707")) |>
  st_transform(32119)
# The region of interest is bordered by four highways
roads_sel <- 
  road_shp |> 
  filter(HWYNUMBER %in% c("15/501","85","885","147")) |>
  st_transform(32119)

# The boundaries can be manually created using estimated coordinates
cut_poly <- st_polygon(list(rbind(
  c(-78.90, 36.02),  # NW
  c(-78.86, 36.02),  # NE
  c(-78.86, 35.96),  # SE
  c(-78.90, 35.96),  # SW
  c(-78.90, 36.02)
)))
cut_poly <- st_sfc(cut_poly, crs = 4326)
cut_poly <- st_transform(cut_poly, st_crs(roads_sel))
# The ZIP regions and roads can be cutoff to focus on the region of interest
zips_cut <- st_intersection(zips_sel, cut_poly)
roads_cut <- st_intersection(roads_sel, cut_poly)

zips_cut    <- st_transform(zips_cut, 4326)
roads_cut  <- st_transform(roads_cut, 4326)
cut_poly  <- st_transform(cut_poly, 4326)

durham <- zip_shp |> filter(CITY == "DURH")
  # # Base region
  # addPolygons(
  #   data = durham,
  #   fillColor = "#e5ecf6",
  #   fillOpacity = 0.6,
  #   color = "#2b2b2b",
  #   weight = 1
  # ) %>%

```


```{r base, echo=TRUE, include=TRUE}

base <- 
  leaflet(options = leafletOptions(preferCanvas = TRUE)) |>
  addProviderTiles(providers$CartoDB) |>
  # ZIP code regions
  addPolygons(
    data = zips_cut,
    fill = FALSE,
    color = "brown",
    weight = 0.5,
    opacity = 0.6
  ) |>
  # Roads
  addPolylines(
    data = roads_cut,
    color = "black",
    weight = 1,
    opacity = 0.7
  ) |>
  # Region of interest
  addPolygons(
    data = cut_poly,
    fill = FALSE,
    color = "red",
    weight = 2,
    dashArray = "5,5"
  )
base

```

### Exploring EPA Data

The have observed the Cadmium concentrations in water and soil, and did not find a significant correlation with the blood Cadmium levels [1](https://pubmed.ncbi.nlm.nih.gov/26449855/). However, there were no measurements of Cadmium in the air and considering that the Durham county has quite a few industries, it is worth checking the EPA data for emissions in general.

```{r epa_data_cleaning}

epa_df <- read_csv("C:/Users/amaan/Desktop/Project/website/GIS_Data_Code/EPA_2023_nc.csv", col_names = TRUE)

epa_durham <-
  epa_df |>
  rename(
    "Facility_Name" = "4. FACILITY NAME",
    "Street_Address" = "5. STREET ADDRESS",
    "City" = "6. CITY",
    "County" = "7. COUNTY",
    "ZIP" = "9. ZIP",
    "Latitude" = "12. LATITUDE",
    "Longitude" = "13. LONGITUDE",
    "Industry" = "23. INDUSTRY SECTOR",
    "Chemical" = "37. CHEMICAL",
    "Unit" = "50. UNIT OF MEASURE",
    "Fugitive_Air" = "51. 5.1 - FUGITIVE AIR",
    "Stack_Air" = "52. 5.2 - STACK AIR",
    "Water" = "53. 5.3 - WATER",
    "Underground" = "54. 5.4 - UNDERGROUND",
    "Total_On_Site" = "65. ON-SITE RELEASE TOTAL"
  ) |>
  filter(City == "DURHAM") |>
  arrange(desc(Total_On_Site)) |>
  select(
    Chemical,Facility_Name,ZIP,
    Total_On_Site,Fugitive_Air,Stack_Air,Water,Underground,Unit,
    Industry,Street_Address,Longitude,Latitude
    )

```

```{r epa_data, include=TRUE}
epa_durham |>
  arrange(desc(Total_On_Site)) |>
  select(Chemical,Facility_Name,ZIP,Total_On_Site) |>
  head(10)
```

None of the emissions are Cadmium and Cadmium compounds.

However, it is still worth observing the emissions in the region of interest because it leads to air pollution and detrimental health.
The measurements for all emissions are in pounds here which allows for easy comparison.

The facilities mostly have emissions under stack air which means the emissions are released through controlled airways, but Brenntag Mid-South mostly has emissions under fugitive air which means the emissions are leaked unintentionally and possibly due to faulty equipment.

No emissions are released into the water or underground which matches the findings from the study a decade ago when no significant associations were found between Cadmium blood levels and Cadmium concentrations in water and soil [1](https://pubmed.ncbi.nlm.nih.gov/26449855/), and possibly demonstrates that the finding still holds in the present as no emissions are released into the water or underground. 

```{r epa_data_anlaysis}

epa_locations <-
  epa_durham |>
  group_by(Facility_Name,ZIP,Longitude,Latitude) |>
  summarize(Total_Emissions=sum(Total_On_Site),.groups="drop") |>
  arrange(desc(Total_Emissions)) |>
  filter(Total_Emissions > 100)
epa_locations

# The region of interest is partially in the ZIP region 27703. 
# The region has the most facilities and 3 of the facilities with the highest total emissions.

```

A lot of the facilities with emissions are in the ZIP code regions covered by the region of interest. It is worth looking into forming clusters and checking if the cluster of facilities is in the region.

I am used to scaling the data every time before clustering so I was getting unusual results until I realized that scaling is not needed here. For Geolocation data, latitude and longitude have meaningful raw values and an inherent spatial relationship in distance.

```{r epa_data_clustering, echo=TRUE, include=TRUE}

# Select the data for clustering
epa_cluster <- 
  epa_locations |> 
  select(Longitude,Latitude)
# Create the plot to find a suitable k
#* The default for k.max is 10 so set it manually to 4 because the number of clusters must be less than the number of data points for a meaningful clustering.
elbow_plot <- 
  fviz_nbclust(epa_cluster, kmeans, method = "wss", k.max = 4) +
  labs(title = "Elbow Method Plot")
# K-Means
fit <- kmeans(epa_cluster, centers = 3, iter.max = 50, nstart = 20)
epa_locations$Cluster <- fit$cluster

# Calculate the mean/centroids of each cluster for plotting
epa_k <-
  epa_locations |>
  group_by(Cluster) |>
  summarize(
    Longitude_Center = mean(Longitude),
    Latitude_Center = mean(Latitude)
  ) |>
  select(Cluster,Longitude_Center,Latitude_Center)

```

```{r epa_map, include=TRUE}

epa_locations_sf <- st_as_sf(epa_k, coords = c("Longitude_Center", "Latitude_Center"), crs = 4269)
epa_locations_sf <- st_transform(epa_locations_sf,st_crs(cut_poly))

# Focus on the clusters in the region of interest
epa_point <- st_intersection(epa_locations_sf,cut_poly)
epa_point <- st_transform(epa_point,4326)

base |>
  addCircleMarkers(
    data = epa_point,
    label = "Factory",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "red",
    color = "red",
    weight = 5
  )

```

The region of interest contains the center of the cluster of the top facilities in terms of emission. Though Cadmium and Cadmium compounds are not emitted by any facility, some of the other chemicals that are released or leaked have been linked with low birth weight in animals and are a cause for concern for pregnant individuals in general.


### Possible Subsidized Housing Options

The data available for subsidized housing is from 2014 and unfortunately it has not been updated. Most of the subsidies have ended. The owners of these housing options are non-profits and the subsidies are rarely not renewed so we can assume the subsidies were eligible for renewal.

```{r housing_data_cleaning}

house_df <- read_csv("C:/Users/amaan/Desktop/Project/website/GIS_Data_Code/Durham_Subsidized_Housing_2014.csv", col_names = TRUE)

house <- 
  house_df |>
  separate(
    "Location 1", into = c("Street_Address","City_ZIP","Coordinates"), sep = "\n"
    ) |>
  separate(
    "Coordinates", into = c("Latitude","Longitude"), sep = ","
  ) |>
  mutate(
    across("Latitude", ~ str_remove_all(.x, "\\(")),
    across("Longitude", ~ str_remove_all(.x, "\\)")),
    across("City_ZIP", ~ str_sub(.x, 11))
    ) |>
  mutate(across(c("Longitude","Latitude"), ~ as.numeric(.x))) |>
  filter(`Owner Type` == "Non-Profit") |>
  select(-Street_Address)

house_sf <- st_as_sf(house, coords = c("Longitude", "Latitude"), crs = 4269)
house_sf <- st_transform(house_sf,st_crs(cut_poly))

# Focus on the clusters in the region of interest
house_points <- st_intersection(house_sf,cut_poly)
house_points <- st_transform(house_points,4326)

```

These are the subsidized housing options in the region:

```{r housing_map, include=TRUE}

base |>
  addCircleMarkers(
    data = epa_point,
    label = "Factory",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "red",
    color = "red",
    weight = 5
  ) |>
  addCircles(
    data = house_points,
    fill = "blue",
    color = "blue",
    weight = 5
  )

```

We will be further exploring other environmental and infrastructural factors that affect health so for the sake of simplicity, it will be better to use a single housing data point, and so we can create clusters and use the cluster with the most houses as the single data point.

```{r housing_data_clustering}

houses <-
  house |>
  filter(`Property Name` %in% house_points$`Property Name`)

# Select the data for clustering
houses_cluster <- 
  house |> 
  filter(`Property Name` %in% house_points$`Property Name`) |>
  select(Longitude,Latitude)
# Create the plot to find a suitable k
#* The default for k.max is 10 so set it manually to 7 because the number of clusters must be less than the number of data points for a meaningful clustering.
elbow_plot <-
  fviz_nbclust(houses_cluster, kmeans, method = "wss", k.max = 7) +
  labs(title = "Elbow Method Plot")

# K-Means
fit <- kmeans(houses_cluster, centers = 3, iter.max = 50, nstart = 20)
houses$Cluster <- fit$cluster

# Calculate the mean/centroid of each cluster for plotting
house_k <-
  houses |>
  group_by(Cluster) |>
  summarize(
    Longitude_Center = mean(Longitude),
    Latitude_Center = mean(Latitude)
  ) |>
  select(Cluster,Longitude_Center,Latitude_Center)

```


```{r housing_cluster_data, include=TRUE}

houses |>
  mutate(`Property Name` = str_to_title(`Property Name`)) |>
  select(`Property Name`,Cluster,`Total Units`,`Active Subsidies`,
         `Owner Type`)

```

We see that one of the clusters has five houses with plenty of total units. Unfortunately we do not know if and how many subsidies are active but we can try to inquire later.

```{r housing_cluster_map, include=TRUE}

house_cluster_sf <- st_as_sf(house_k, coords = c("Longitude_Center", "Latitude_Center"), crs = 4269)
house_cluster_sf <- st_transform(house_cluster_sf,st_crs(cut_poly))

# Focus on cluster 1 which has the most houses
houses_point1 <-
  house_cluster_sf |>
  filter(Cluster == 1)
houses_point1 <- st_transform(houses_point1,4326)

base |>
  addCircleMarkers(
    data = epa_point,
    label = "Factory",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "red",
    color = "red",
    weight = 5
  ) |>
  addCircleMarkers(
    data = houses_point1,
    label = "House",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "blue",
    color = "blue",
    weight = 5
  )

```

### Green Space

3-30-300 Rule (for equitable access):
3: See at least three trees from your window.
30: Have 30% tree canopy cover in your neighborhood.
300: Live within 300 meters of a quality park or green space.

```{r trees_data_cleaning}

tree_shp_file <- st_read("C:/Users/amaan/Desktop/Project/GIS/Trees_%26_Planting_Sites/Trees_%26_Planting_Sites.shp", quiet = TRUE)
tree_shp <-
  tree_shp_file |>
  filter(
    present == "Tree",
    neighborho %in% c("Downtown","Old East Durham","Other",NA)) |>
  select(
    OBJECTID,streetaddr,zipcode,facilityid,neighborho,
    genus,species,commonname,heightft,condition,
    vocs,pm10remove,pm25remove,polremoved,
    leafarea_s,
    geometry
    )

tree_shp <- st_transform(tree_shp,4326)
trees <- st_intersection(tree_shp,cut_poly)

```

We need to create a buffer around the house cluster to capture the canopy around the area. A distance of a 1000m or 1km is enough.

```{r trees_data_1, echo=TRUE, include=TRUE}
houses_point1_buffer <- st_buffer(houses_point1,dist=1000)
trees_houses_point1 <- st_intersection(trees,houses_point1_buffer)
```

The tree data also has the leaf area for each tree which we can use to estimate the area covered by the trees. We can sum and convert the areas of all the trees in the buffer area

```{r trees_data_2, echo=TRUE, include=TRUE}
trees_houses_point1_area <- sum(trees_houses_point1$leafarea_s,na.rm=TRUE)
houses_point1_area <- st_area(houses_point1_buffer)*10.7639
```

The greenery can be calculated by dividing the area of the trees by the area of the buffer around the house cluster.

```{r trees_data_3, echo=TRUE, include=TRUE}
tree_greenery_pct <- (trees_houses_point1_area/houses_point1_area)*100
tree_greenery_pct
```


```{r trees_map, include=TRUE}

houses_point1_buffer <- st_transform(houses_point1_buffer,4326)
trees_houses_point1 <- st_transform(trees_houses_point1,4326)

base |>
  addPolygons(
    data = houses_point1_buffer,
    label = "House",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "blue",
    color = "blue",
    weight = 5
  ) |>
  addCircles(
    data = trees_houses_point1,
    color = "green",
    weight = 1
  )

```


```{r parks_data_cleaning}

park_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/Parks/Parks.shp", quiet = TRUE)

park_shp <- st_transform(park_shp,4326)
parks <- st_intersection(park_shp,cut_poly)

```

We need to find the nearest parks and check if they are within the region.

```{r parks_data, echo=TRUE, include=TRUE}

dists <- as.vector(st_distance(houses_point1,parks))
parks$Distance <- dists

parks_houses_point1 <- 
  parks |>
  filter(Distance <= 1000) |>
  arrange(Distance) |>
  select(NAME,Distance,PARKACRES)
parks_houses_point1 |> 
  as_tibble() |> 
  select(-geometry)

```

```{r parks_map, include=TRUE}

base |>
  addCircleMarkers(
    data = houses_point1,
    label = "House",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "blue",
    color = "blue",
    weight = 5
  ) |>
  addPolygons(
    data = parks_houses_point1,
    fill = "green",
    color = "green",
    weight = 5
  )
  
```



### GoDurham Bus Routes


```{r routes_data_cleaning}

route_shp_file <- st_read("C:/Users/amaan/Desktop/Project/GIS/PublicTransit_Routes/GoDurham_Bus_Routes.shp",quiet = TRUE)

route_shp_file$line_name

route_shp <-
  route_shp_file |>
  separate(
    line_name, into = c("line_number"), sep = " "
  )
routes <- st_transform(route_shp,32119)
route3C <- 
  routes |> 
  filter(line_number == "3C")

routes <- st_transform(routes,4326)
route3C <- st_transform(route3C,4326)

```


```{r routes_map, include=TRUE}

base_plan <-
  base |>
  addCircleMarkers(
    data = houses_point1,
    label = "House",
    labelOptions = labelOptions(noHide = TRUE,textOnly = TRUE,
                                direction = "bottom"),
    fill = "blue",
    color = "blue",
    weight = 5
  ) |>
  addPolylines(
    data = route3C,
    label = ~line_number,
    color = "darkblue",
    weight = 3
  )
base_plan

```


### Acccess to Grocery and Healthy Foods

There was a study that explored the impact of a Mediterranean diet on blood Cadmium levels, and though there was no significant association with diet, the conclusion of the study was that diet is a factor that is still worth exploring [2](https://pmc.ncbi.nlm.nih.gov/articles/PMC7712046/). In any case then, it also helps to see if free food is available for the residents to possibly use it as places to distribute foods that can potentially affect blood Cadmium levels.

```{r foods_data_cleaning}

food_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/Food_Pantries/Food_Pantries.shp", quiet = TRUE)

cut_poly <- st_transform(cut_poly,32119)
food_shp <- st_transform(food_shp,32119)
foods <- 
  st_intersection(food_shp,cut_poly)
foods <- st_transform(foods,4326)

```

```{r foods_data, include=TRUE}
foods$name
```
The region of interest has 19 food pantries with the vast majority being churches.

```{r foods_map, include=TRUE}
base_plan |>
  addCircles(
    data = foods,
    label = ~name,
    fill = "green",
    color = "green",
    weight = 5
  )   
```


```{r farms_data_cleaning}

farm_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/Farmers_Markets/Farmers_Markets.shp", quiet = TRUE)

cut_poly <- st_transform(cut_poly,32119)
farm_shp <- st_transform(farm_shp,32119)
farms <- 
  st_intersection(farm_shp,cut_poly)
farms <- st_transform(farms,4326)

```

```{r farms_data, include=TRUE}
farms$name
```
The region of interest has 2 farmers' markets.

```{r farms_map, include=TRUE}
base_plan |>
  addCircles(
    data = farms,
    label = ~name,
    fill = "green",
    color = "green",
    weight = 5
  )   
```

